#######################################
# RabbitMQ Configuration File
#######################################

# Enable the management plugin
management.tcp.port = 15672
management.tcp.ip = 0.0.0.0

#######################################
# General Settings
#######################################
log.console = true
log.console.level = warning
log.dir = /var/log/rabbitmq
log.file = rabbit.log

# Enable HiPE (optional, improve performance by compiling certain parts of RabbitMQ to native code)
hipe_compile = true

#######################################
# Networking and Ports
#######################################
listeners.tcp.default = 5672
tcp_listen_backlog = 4096
total_connections_limit = 50000
channel_max = 2048

# Tune TCP keepalive settings for better resource management
heartbeat = 60
tcp_listen_options.backlog = 4096
tcp_listen_options.nodelay = true

# Socket buffers (optimize based on system load)
socket_opts.sndbuf = 196608
socket_opts.rcvbuf = 196608

#######################################
# Memory and Resource Limits
#######################################
vm_memory_high_watermark.relative = 0.7  # Use 70% of total system memory for RabbitMQ
# Absolute memory limit (optional)
# vm_memory_high_watermark.absolute = 4096MB

disk_free_limit.relative = 1.0  # Stop when disk usage exceeds 90%
# Alternatively, set an absolute limit (e.g., 2GB)
# disk_free_limit.absolute = 2GB

limits.max_file_descriptors = 66536

#######################################
# Message Store and Queue Settings
#######################################
queue_max_length = 15000
queue_max_bytes = 150MB

# Lazy queues (offload queue data to disk for infrequent consumers)
queue_master_locator = min-masters
default_queue_type = lazy

# TTL (Time-to-Live) settings to avoid message accumulation
# Set message TTL to 1 hour (3600000 ms)
default_message_ttl = 3600000

# Sync settings to ensure message persistence with a database
# Using a mirrored queue for HA (high availability)
ha-mode = all  # Mirror across all nodes for failover
ha-sync-mode = automatic  # Automatically synchronize mirrors

#######################################
# Clustering (optional, for HA)
#######################################
# Cluster settings for high availability
# cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config
# cluster_formation.classic_config.nodes.1 = rabbit@rabbitmq1
# cluster_formation.classic_config.nodes.2 = rabbit@rabbitmq2
# cluster_partition_handling = pause_minority  # Prevent split-brain scenarios

#######################################
# Authentication and Security
#######################################
# Enforce SSL/TLS
# listeners.ssl.default = 5671
# ssl_options.cacertfile = /etc/rabbitmq/cert/ca_certificate.pem
# ssl_options.certfile = /etc/rabbitmq/cert/server_certificate.pem
# ssl_options.keyfile = /etc/rabbitmq/cert/server_key.pem
# ssl_options.verify = verify_peer
# ssl_options.fail_if_no_peer_cert = true
# Enable TLS 1.2 and disable older, less secure versions
# ssl_options.versions.1 = tlsv1.2
# ssl_options.versions.2 = tlsv1.3
# Use strong cipher suites
# ssl_options.ciphers.1 = ECDHE-RSA-AES256-GCM-SHA384
# ssl_options.ciphers.2 = ECDHE-RSA-AES128-GCM-SHA256

#######################################
# Management and Monitoring
#######################################
# Statistics and resource management
collect_statistics_interval = 5000  # Collect stats every 5 seconds
rates_mode = none  # Disable per-second rate computation to save resources

# Enable Prometheus for monitoring
prometheus.tcp.port = 15692

#######################################
# Disk Synchronization (like database sync)
#######################################
# Ensure queues are persisted and sync is handled efficiently with disk
queue_index_embed_msgs_below = 4096  # Store messages smaller than 4KB in memory
mnesia_table_loading_retry_limit = 10
mnesia_table_loading_retry_timeout = 30000

# Fine-tuning the number of I/O threads for disk synchronization
disk_io_limit = 104857600  # 100MB/s I/O limit to prevent disk saturation
disk_io_coefficient = 1.5  # Adjust the I/O scheduling balance between RabbitMQ processes and message syncing
